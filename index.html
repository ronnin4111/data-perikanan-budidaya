<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard Data Pelaku Usaha Perikanan â€” Clean Blue</title>

<!-- Leaflet CSS/JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    :root{
        --bg:#f4f8fc;
        --card:#ffffff;
        --muted:#5b6b78;
        --accent:#1e67c8;
        --accent-600:#0f4fa8;
        --success:#1b8b4a;
        --danger:#e03e3e;
        --shadow: 0 8px 28px rgba(14,29,56,0.06);
    }

    /* Header styles */
    .header-top {
        background: var(--accent);
        color: white;
        padding: 8px 16px;
        border-radius: 8px;
        margin-bottom: 12px;
    }

    .header-info {
        display: flex;
        justify-content: flex-end;
        gap: 20px;
        font-size: 14px;
    }

    .header-main {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 12px;
    }

    .logo-container {
        flex-shrink: 0;
    }

    .logo {
        width: 80px;
        height: auto;
        object-fit: contain;
    }

    .header-text {
        flex: 1;
    }

    /* Rest of your existing styles */
    *{box-sizing:border-box}
    body{
        margin:0;
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        background:var(--bg);
        color:#0b2340;
        padding:18px;
    }

    /* Your existing styles remain the same */
    /* ... */

    /* Chart Container */
    .chart-container {
        position: relative;
        height: 400px;
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
    }

    #pieCanvas {
        width: 100% !important;
        height: 100% !important;
    }

    /* Existing styles continue... */
</style>
</head>
<body>

<!-- Header with time and user info -->
<header>
    <div class="header-top">
        <div class="header-info">
            <span id="current-time">2025-10-14 18:44:59</span>
            <span class="user-info">ðŸ‘¤ User: ronnin4111</span>
        </div>
    </div>
    <div class="header-main">
        <div class="logo-container">
            <img src="logo.png" alt="Logo" class="logo">
        </div>
        <div class="header-text">
            <h1>DATA PELAKU USAHA PERIKANAN DPKPP KAB.MEMPAWAH</h1>
            <p>Filter interaktif â€” klik filter untuk membuka daftar. Statistik, peta, chart, dan tabel menyesuaikan hasil filter.</p>
        </div>
    </div>
</header>

<!-- Rest of your HTML structure remains the same until chart controls -->

<div class="chart-controls">
    <label for="chartFilter">Tampilkan berdasarkan:</label>
    <select id="chartFilter">
        <option value="wadahBudidaya">Wadah Budidaya</option>
        <option value="jenisUsaha">Jenis Usaha</option>
        <option value="kecamatan">Kecamatan</option>
        <option value="desa">Desa</option>
        <option value="jenisIkan">Jenis Ikan</option>
    </select>
    <label for="chartType" class="ml-10">Tipe chart:</label>
    <select id="chartType">
        <option value="pie">Pie</option>
        <option value="bar">Bar</option>
    </select>
</div>

<div class="chart-container">
    <canvas id="pieCanvas"></canvas>
</div>

<!-- Rest of your HTML structure -->

<script>
// Your existing JavaScript with these modifications:

document.addEventListener('DOMContentLoaded', function() {
    // Initial setup
    updateTime();
    setInterval(updateTime, 1000);

    // Fetch and initialize data
    fetch(SHEET_JSON)
        .then(r => r.text())
        .then(txt => {
            const json = JSON.parse(txt.substr(47).slice(0, -2));
            GLOBAL.cols = json.table.cols;
            GLOBAL.rows = json.table.rows || [];
            detectColumns();
            initMap();
            initFiltersAndPanels();
            applyUpdate();
        })
        .catch(err => {
            console.error('Gagal ambil data sheet', err);
            alert('Gagal ambil data Google Sheet. Periksa koneksi atau akses sheet.');
        });
});

// Update time function
function updateTime() {
    const now = new Date();
    const formatted = now.getUTCFullYear() + '-' + 
                     String(now.getUTCMonth() + 1).padStart(2, '0') + '-' + 
                     String(now.getUTCDate()).padStart(2, '0') + ' ' + 
                     String(now.getUTCHours()).padStart(2, '0') + ':' + 
                     String(now.getUTCMinutes()).padStart(2, '0') + ':' + 
                     String(now.getUTCSeconds()).padStart(2, '0');
    document.getElementById('current-time').textContent = formatted + ' UTC';
}

// Fixed buildPieAndRender function
function buildPieAndRender(rows) {
    const groupBy = document.getElementById('chartFilter').value;
    const chartType = document.getElementById('chartType').value;

    const agg = {};
    rows.forEach(r => {
        if (groupBy === 'jenisIkan') {
            [COL.ikanUtama, COL.ikanTambahan1, COL.ikanTambahan2].forEach(colIndex => {
                if (colIndex >= 0 && r.c[colIndex]?.v) {
                    const ikanValue = r.c[colIndex].v.toString().trim();
                    if (ikanValue) {
                        agg[ikanValue] = (agg[ikanValue] || 0) + 1;
                    }
                }
            });
        } else {
            const key = (r.c[COL[groupBy]]?.v || 'Tidak diisi').toString();
            agg[key] = (agg[key] || 0) + 1;
        }
    });

    const pairs = Object.keys(agg).map(k => ({k,v:agg[k]})).sort((a,b)=>b.v-a.v);
    const TOP = 8;
    const top = pairs.slice(0,TOP), rest = pairs.slice(TOP);
    const labels = top.map(p=>p.k), values = top.map(p=>p.v);
    if(rest.length){ labels.push('Lainnya'); values.push(rest.reduce((s,p)=>s+p.v,0)); }

    if(pieChart) pieChart.destroy();

    const config = {
        type: chartType,
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: chartType === 'bar' ? '#1e67c8' : generateColors(labels.length),
                borderWidth: chartType === 'bar' ? 0 : 1,
                borderRadius: chartType === 'bar' ? 4 : 0
            }]
        },
        options: {
            indexAxis: chartType === 'bar' ? 'y' : undefined,
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: chartType !== 'bar',
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${value.toLocaleString('id-ID')} (${percentage}%)`;
                        }
                    }
                }
            },
            scales: chartType === 'bar' ? {
                x: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        font: {
                            weight: 'bold'
                        },
                        color: '#000'
                    }
                },
                y: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            weight: 'bold'
                        },
                        color: '#000'
                    }
                }
            } : undefined
        }
    };

    pieChart = new Chart(pieCtx, config);
}

// Rest of your JavaScript code remains the same
</script>

</body>
</html>
